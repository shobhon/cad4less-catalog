{% extends 'base.html' %}
{% block content %}
<h2>Builds</h2>

<p>
  <a class="btn" href="{{ url_for('new_build_form') }}">New Build</a>
  <button class="btn secondary" type="button" onclick="submitBulkDelete()">Delete Selected</button>
</p>

<!-- Standalone form used only for bulk delete (populated by JS) -->
<form id="bulkDeleteForm" method="post" action="{{ url_for('delete_builds') }}"></form>

{% if builds %}
<table>
  <thead>
    <tr>
      <th style="width:36px;">
        <input type="checkbox" id="selectAll" onclick="for(const cb of document.querySelectorAll('.row-select')) cb.checked=this.checked;">
      </th>
      <th>ID</th>
      <th>Name</th>
      <th>Price (editable)</th>
      <th>Created</th>
    </tr>
  </thead>
  <tbody>
  {% for b in builds %}
    <tr>
      <td><input class="row-select" type="checkbox" value="{{ b.id }}"></td>
      <td>{{ b.id }}</td>
      <td><a href="{{ url_for('build_specification', build_id=b.id) }}">{{ b.name }}</a></td>
      <td>
        <!-- Separate form for price update to avoid nesting -->
        <form method="post" action="{{ url_for('update_build_price', build_id=b.id) }}" style="display:flex; gap:6px; align-items:center; margin:0;">
          <input name="price" value="{{ '%.2f'|format(b.price) if b.price is not none else '' }}" placeholder="e.g. 1299.00" style="width:120px">
          <button class="btn secondary" type="submit">Update</button>
        </form>
      </td>
      <td>{{ b.created_at }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p><em>No builds yet.</em></p>
{% endif %}

<script>
function submitBulkDelete(){
  const form = document.getElementById('bulkDeleteForm');
  // clear existing hidden inputs
  [...form.querySelectorAll('input[name="selected_ids"]')].forEach(e => e.remove());
  // collect checked rows
  const checked = [...document.querySelectorAll('.row-select:checked')];
  if(checked.length === 0){
    alert('Select at least one build to delete.');
    return;
  }
  checked.forEach(cb => {
    const i = document.createElement('input');
    i.type = 'hidden';
    i.name = 'selected_ids';
    i.value = cb.value;
    form.appendChild(i);
  });
  if(confirm('Delete selected builds? This cannot be undone.')){
    form.submit();
  }
}
</script>
{% endblock %}