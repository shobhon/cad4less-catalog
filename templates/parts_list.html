{% extends 'base.html' %}
{% block content %}
<h2>Parts</h2>

<p>
  <a class="btn" href="{{ url_for('import_catalog') }}">Import CSV</a>
  <a class="btn primary" href="{{ url_for('new_part_form') }}">Add New Part</a>
  <button class="btn secondary" type="button" onclick="submitBulkDelete()">Delete Selected</button>
</p>

<!-- Standalone form used only for bulk delete (populated by JS) -->
<form id="bulkDeleteForm" method="post" action="{{ url_for('delete_parts_bulk') }}"></form>

{% if parts %}
<table>
  <thead>
    <tr>
      <th style="width:36px;">
        <input type="checkbox" id="selectAll" onclick="for(const cb of document.querySelectorAll('.row-select')) cb.checked=this.checked;">
      </th>
      <th>Name</th>
      <th>Category</th>
      <th>Brand</th>
      <th>URL</th>
      <th>Price</th>
    </tr>
  </thead>
  <tbody>
  {% for p in parts %}
    <tr>
      <td><input class="row-select" type="checkbox" value="{{ p.id }}"></td>
      <td><a href="{{ url_for('edit_part_form', part_id=p.id) }}">{{ p.name }}</a></td>
      <td>{{ p.category }}</td>
      <td>{{ p.brand or "" }}</td>
      <td>{% if p.url %}<a href="{{ p.url }}" target="_blank" rel="noopener">Link</a>{% endif %}</td>
      <td>{% if p.price is not none %}${{ "%.2f"|format(p.price) }}{% endif %}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p><em>No parts found. Try importing a CSV or add a new part.</em></p>
{% endif %}

<script>
function submitBulkDelete(){
  const form = document.getElementById('bulkDeleteForm');
  [...form.querySelectorAll('input[name="selected_ids"]')].forEach(e => e.remove());
  const checked = [...document.querySelectorAll('.row-select:checked')];
  if(checked.length === 0){ alert('Select at least one part to delete.'); return; }
  checked.forEach(cb => {
    const i = document.createElement('input');
    i.type = 'hidden'; i.name = 'selected_ids'; i.value = cb.value;
    form.appendChild(i);
  });
  if(confirm('Delete selected parts? This cannot be undone.')){ form.submit(); }
}
</script>
{% endblock %}